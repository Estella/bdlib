# $Id$

include ./.deps/includes

SHELL = @SHELL@
top_srcdir = @top_srcdir@
srcdir = @srcdir@
libdir = $(top_srcdir)/lib
VPATH = @srcdir@
CCDEPMODE = @CCDEPMODE@

include $(top_srcdir)/build/build.mk

@SET_MAKE@

CXXFLAGS = @CXXFLAGS@ -I$(srcdir) -I$(top_srcdir) -I$(top_srcdir)/build -I$(libdir)/wraith -I$(libdir)/bdlib -I$(libdir)/openssl @DEFS@ $(CFLGS) '-DREVISION="$(REVISION)"' -DBUILDTS=$(BUILDTS)

OBJCOPY = @OBJCOPY@

OBJS = main.o

MAKE_GENERIC = $(MAKE) 'MAKE=$(MAKE)' 'CXX=$(CXX)' 'LD=$(LD)' 'STRIP=$(STRIP)' 'CFLGS=$(CFLGS)' 'CCDEPMODE=$(CCDEPMODE)'

.PHONY: default check clean distclean build_msg $(BINEXEC)

default:
	@echo ""
	@echo "Use the build script."
	@echo ""

$(WRAITH):
	@cd $(top_srcdir)/lib/wraith && $(MAKE) wraith

$(WRAITH_UNITS):
	@cd $(top_srcdir)/lib/wraith/tests && $(MAKE) units

$(BDLIB):
	@cd $(top_srcdir)/lib/bdlib && $(MAKE) bdlib

$(BDLIB_UNITS):
	@cd $(top_srcdir)/lib/bdlib/tests && $(MAKE) units


$(OPENSSL):
	@cd $(top_srcdir)/lib/openssl && $(MAKE) openssl

ALL_LIBS = $(OBJS) $(BDLIB) $(WRAITH) $(OPENSSL)

../$(BINEXEC): build_msg $(ALL_LIBS)
	@echo "[*] Linking $(BINEXEC)... $(BINBUILD)"
	$(LD) -o $@ $(ALL_LIBS) $(LIBS)
	@$(STRIP) $@
	@$(OBJCOPY) $@
	@echo "Successful compile: $(BINEXEC)"

$(BINEXEC): ../$(BINEXEC)

$(CORE_UNITS):
	+@cd tests && $(MAKE) units

UNITOBJS = $(CORE_UNITS) $(WRAITH_UNITS) $(BDLIB_UNITS)

check: UnitRunner.o $(ALL_LIBS) $(UNITOBJS)
	$(LD) @CPPUNIT_LIBS@ -o UnitRunner@EXEEXT@ $< $(ALL_LIBS) $(UNITOBJS)

clean:
	@rm -f .depend *.o *~ *.lo UnitRunner@EXEEXT@
	-+@cd tests && $(MAKE) clean

distclean: clean
	@rm -rf .deps Makefile
	-+@cd tests && $(MAKE) distclean

build_msg:
	@echo "[*] Compiling core components"
