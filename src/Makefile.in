# $Id$

include ./.deps/includes

SHELL = @SHELL@
top_srcdir = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@
CCDEPMODE = @CCDEPMODE@

include $(top_srcdir)/build/build.mk

@SET_MAKE@

CXXFLAGS = @CXXFLAGS@ $(CFLGS) -I$(srcdir) -I$(top_srcdir) -I$(top_srcdir)/build -I$(top_srcdir)/lib @DEFS@ '-DREVISION="$(REVISION)"' -DBUILDTS=$(BUILDTS)

OBJCOPY = @OBJCOPY@

OBJS = main.o

MAKE_GENERIC = $(MAKE) 'MAKE=$(MAKE)' 'CXX=$(CXX)' 'LD=$(LD)' 'STRIP=$(STRIP)' 'CFLGS=$(CFLGS)' 'CCDEPMODE=$(CCDEPMODE)'

#.PHONY: default check clean distclean build_msg $(BINEXEC) $(WRAITH) $(WRAITH_UNITS) $(BDLIB) $(BDLIB_UNITS) $(OPENSSL) $(CORE_UNITS)
.PHONY: default check clean distclean build_msg $(BINEXEC) $(WRAITH_UNITS) $(BDLIB_UNITS) $(CORE_UNITS)

default:
	@echo ""
	@echo "Use the build script."
	@echo ""

ALL_LIBS = $(OBJS) $(WRAITH) $(BDLIB) $(OPENSSL)

../$(BINEXEC): build_msg $(ALL_LIBS)
	@echo "[LD] 	$@"
	$(LD) -o $@ $(ALL_LIBS) $(LIBS)
	$(STRIP) $@
	$(OBJCOPY) $@
	@echo "Successful compile: $(BINEXEC)"

$(BINEXEC): ../$(BINEXEC)

UNITOBJS = $(CORE_UNITS) $(WRAITH_UNITS) $(BDLIB_UNITS)

check: UnitRunner.o $(ALL_LIBS) $(UNITOBJS)
	$(LD) @CPPUNIT_LIBS@ -o UnitRunner@EXEEXT@ $< -Wl,--whole-archive $(UNITOBJS) -Wl,--no-whole-archive $(subst main.o,,$(ALL_LIBS))

clean:
	@rm -f .depend *.o *~ *.lo UnitRunner@EXEEXT@
	-+@cd tests && $(MAKE) clean

distclean: clean
	@rm -rf .deps Makefile
	-+@cd tests && $(MAKE) distclean

build_msg:
	@echo "[*] Compiling core components"
