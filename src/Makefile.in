# $Id$

include ./.deps/includes

SHELL = @SHELL@
top_srcdir = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@
CCDEPMODE = @CCDEPMODE@

include $(top_srcdir)/build/build.mk

@SET_MAKE@

CXXFLAGS = @CXXFLAGS@ -I$(srcdir) -I$(top_srcdir) -I$(top_srcdir)/build -I$(top_srcdir)/lib/wraith -I$(top_srcdir)/lib/bdlib @DEFS@ $(CFLGS) '-DREVISION="$(REVISION)"' -DBUILDTS=$(BUILDTS)

OBJCOPY = @OBJCOPY@

OBJS = main.o

MAKE_GENERIC = $(MAKE) 'MAKE=$(MAKE)' 'CXX=$(CXX)' 'LD=$(LD)' 'STRIP=$(STRIP)' 'CFLGS=$(CFLGS)' 'CCDEPMODE=$(CCDEPMODE)'

.PHONY: default check clean distclean build_msg $(BINEXEC) compile

default:
	@echo ""
	@echo "Use the build script."
	@echo ""

WRAITH = $(top_srcdir)/lib/wraith.la
WRAITH_UNITS = $(top_srcdir)/lib/wraith_units.la
BDLIB = $(top_srcdir)/lib/bdlib.la
BDLIB_UNITS = $(top_srcdir)/lib/bdlib_units.la

$(WRAITH):
	@cd $(top_srcdir)/lib/wraith && $(MAKE) wraith

$(WRAITH_UNITS):
	@cd $(top_srcdir)/lib/wraith/tests && $(MAKE) units

$(BDLIB):
	@cd $(top_srcdir)/lib/bdlib && $(MAKE) bdlib

$(BDLIB_UNITS):
	@cd $(top_srcdir)/lib/bdlib/tests && $(MAKE) units


compile: $(OBJS) $(BDLIB) $(WRAITH)

../$(BINEXEC): build_msg compile
	@echo ""
	@echo "Linking $(BINEXEC)... $(BINBUILD)"
	@echo ""
	$(LD) -o $@ $(OBJS) $(BDLIB) $(WRAITH) $(LIBS)
	@$(STRIP) $@
	@$(OBJCOPY) $@
	@echo "Successful compile: $(BINEXEC)"
	@echo ""

$(BINEXEC): ../$(BINEXEC)

CORE_UNITS = tests/core_units.la
$(CORE_UNITS):
	+@cd tests && $(MAKE) units

UNITOBJS = $(CORE_UNITS) $(WRAITH_UNITS) $(BDLIB_UNITS)

check: UnitRunner.o compile $(UNITOBJS)
	$(LD) @CPPUNIT_LIBS@ -o UnitRunner@EXEEXT@ $< $(OBJS) $(BDLIB) $(WRAITH) $(UNITOBJS)

clean:
	@rm -f .depend *.o *~ *.lo UnitRunner@EXEEXT@
	-+@cd tests && $(MAKE) clean

distclean: clean
	@rm -rf .deps Makefile
	-+@cd tests && $(MAKE) distclean

build_msg:
	@echo "[*] Compiling core components"
